<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>PB100 Weather Station</title>
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="styles.css" rel="stylesheet" />
</head>

<body>
    <div class="jumbotron vertical-center text-center">
        <h1 class="display-4">PB100</h1>
        <p class="lead">Loading components for application</p>
        <hr class="my-4">
        <p id="progress">Loading...</p>
        <p id="errors"></p>
    </div>
</body>
<script>
    window.onbeforeunload = function () {
        return "If you leave, real time data charts will be reset";
    }
    // Load the components 1 by 1 so that we don't hammer the ESP
    // which can only handle 4 request at a time
    var sources = [
        "jquery.min.js",
        "bootstrap.bundle.min.js",
        "feather.min.js",
        "highcharts.js",
        "highcharts-more.js",
        "windbarb.js",
        "solid-gauge.js"
    ];
    var idx = 0;
    var downloadComplete = true;
    var progress = document.getElementById("progress");
    var errors = document.getElementById("errors");

    function getNextSource() {
        var source = sources[idx];
        var req = new XMLHttpRequest();
        downloadComplete = false;
        progress.innerHTML = "Downloading: " + source;
        req.addEventListener('readystatechange', function (e) {
            if (req.readyState == 4 && req.status == 200) {
                // Downloading has finished
                var script = document.createElement('script');
                script.innerHTML = req.response;
                document.body.appendChild(script);
                downloadComplete = true;
                idx++;
            } else if (req.readyState == 4) {
                // Failed
                notifyFailed(source);
            }
        });

        // progress percent of file
        req.addEventListener('progress', function (e) {
            if (e.lengthComputable === true) {
                var download_percent = (e.loaded / e.total) * 100;
                console.log(download_percent);
            }
        });

        req.responseType = 'text';
        req.open('GET', source);
        req.send();
    }

    var ticktimer = setInterval(function () {
        if (idx >= sources.length) {
            clearInterval(ticktimer);
            progress.innerHTML = "Starting application";
            getMainPage();
        } else {
            if (downloadComplete) {
                getNextSource();
            }
        }
    }, 250);

    function getMainPage() {
        var xhttp = new XMLHttpRequest();
        xhttp.open('GET', 'app.html', true);
        xhttp.setRequestHeader('Content-type', 'text/plain');
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4) {
                if (this.status == 200) {
                    $('body').html(this.responseText);
                } else {
                    window.alert("Failed (" + this.status.toString() + ")");
                }
            }
        };
        xhttp.send();
    }

    function notifyFailed(source){
        // Add to UI
        errors.innerHTML += "Error: Failed to load: " + source + "<br>" ;
    }
</script>

</html>